"use strict";

var Q = require('q');
var progres = require('./index.js');

var connectionString = 'postgres://localhost';

progres.connect(connectionString, function (client) {

	return [

		// A valid `node-sql` query object should return the resulting rows.
		function () {

			var value = 'passed';

			var generatedSQL = {toQuery: function () { return {
				text: 'SELECT $1::text AS column_name',
				values: [value]
			};}};

			return client.queryGenerated(generatedSQL).then(function (rows) {

				if (rows[0].column_name != value) {

					throw new Error('A valid `node-sql` query object should return the resulting rows.');
				}
			});
		},


		// Passing queryGenerated a broken object should propagate an error.
		function () {

			var brokenQueryObject = "broken query object";

			// Run a broken query.
			return client.queryGenerated(brokenQueryObject).then(function () {

				// This should never execute.
				throw new Error('Passing queryGenerated a broken object should propagate an error.');

			}, function (error) {

				// Passed the test.
			})
		}

	]
		// Run in sequence.
		.reduce(function (soFar, next) { return soFar.then(next); }, Q());
})
	.done(function () {

		console.log("Everything OK.");

	}, function (error) {

		console.error(error);
		process.exit(1);
	});
